:Menu_Mission
NUMBER_PAGE = 1
CURRENT_PAGE = 1

Menu.SetColumn(hPanel, 0, 'M0000WR','M00000/','M00000[','M0000WT','M00007R',none,none,none,none,none,none,none,none)
//Menu.SetColumn(hPanel, 0, 'M0000WR','M00000/','M00000[','M0000WT','M00000{','M00007R',none,none,none,none,none,none,none)

if 0A9A: FILE_HANDLE = DIR_DYOS "ab"
then
    0A9C: FILE_SIZE = file FILE_HANDLE size

    0@ = FILE_SIZE
    if and
        SCM_IN_CONDITION_BLOCK == true
        SCM_IF_EMITTED == false
    then
        0@ += 4

        FILE_COMMAND = VM_IF
        scm_write_command()
    end

    0A9B: file_close FILE_HANDLE
end

Menu.SetItemWithNumber(hPanel, 1, 0, 'M00000-', 0) // #0
Menu.SetItemWithNumber(hPanel, 1, 1, 'M00000]', 0@) // 4b

Menu_Take_Return()
Menu_Take_Selection()
repeat
    if Menu_Close_Forced()
    then jump @Menu_Close
    end

    if Menu_Enter()
    then
        setMenuClear()
        Menu.SetActiveItem(hPanel, 0)

        switch _SELECTED
            case 2 // Start
                if 0A9A: FILE_HANDLE = DIR_DYOS "rb"
                then
                    FILE_OFFSET = 0
                    if SCM_BUFFER_MAIN <> 0
                    then 0AC9: free_allocated_memory SCM_BUFFER_MAIN
                    end

                    0A9C: FILE_SIZE = file FILE_HANDLE size

                    0AC8: SCM_BUFFER_MAIN = allocate_memory_size FILE_SIZE

                    while FILE_OFFSET < FILE_SIZE
                        0AD5: file_seek FILE_HANDLE offset FILE_OFFSET origin 0
                        0A9D: read_file FILE_HANDLE size 1 to 0@

                        2402: write_memory_with_offset SCM_BUFFER_MAIN offset FILE_OFFSET size 1 value 0@
                        FILE_OFFSET += 1
                    end
                    FILE_OFFSET = 0

                    Fs.Close(FILE_HANDLE)
                    Menu_Display_Hide()

                    //printf "cd.. DYOS/#0" WAIT_DEFAULT
                    //call @waitPlis 2 WAIT_DEFAULT false
                    
                    if FILE_SIZE == 0
                    then
                        printf "file not writed" WAIT_ERROR
                        //call @waitPlis 2 WAIT_ERROR false
                        goto @read_found_error
                    else
                        if or
                            FILE_OFFSET == FILE_SIZE
                            FILE_SIZE == 4
                        then
                            printf "file in white" WAIT_ERROR
                            //call @waitPlis 2 WAIT_ERROR false
                            goto @read_found_error
                        end

                        Player_GetLastPosition()

                        Display.SetRadar(true)
                        if not Actor.IsDriving(hPlayer)
                        then Actor.SetCollisionDetection(hPlayer) = true
                        end
                        Player.SetCanMove(hChar) = true

                        int 0@ = 3000 // time
                        int 1@ = 0 // in wait
                        int 2@ // initial value
                        int 3@ // last value
                        
                        call @GET_TIMER 0 2@
                       
                        while true
                            call @GET_TIMER 0 3@
                            3@ -= 2@
                            if 3@ > 0@
                            then break
                            end
                            Wait0()
                            3@ /= 1000
                            1@ = 3 - 3@
                            printf "Start mission on... %i" 10 1@
                        end
                        
                        // FILE_VERSION [XXX][XX]
                        //
                        // [XXX] : INT version
                        // [XX] : INT build
                        SCM_CURRENT_OFFSET = 0
                        read_buffer_Value()
                        FILE_VERSION = 0@

                        printf "version: %i" WAIT_INFO FILE_VERSION
                        call @waitPlis 2 WAIT_INFO false

                        SCM_IF_ACTIVE = 0
                        SCM_ENTER_CONDITION = false
                        SCM_COMMAND_IS_CONDITIONAL = 0
                        SCM_COND_START_OFFSET  = 0

                        SCM_NUM_ACTORS = 0
                        SCM_INDEX_ACTORS = 0

                        while SCM_CURRENT_OFFSET < FILE_SIZE
                            wait0()
                            // Leer comando
                            read_buffer_Value()
                            FILE_COMMAND = 0@

                            scm_read_command()

                            //if SCM_CURRENT_OFFSET == FILE_SIZE
                            //then
                            //    if SCM_ENTER_CONDITION == true
                            //    then
                            //        if SCM_CONT_CONDITION <> SCM_IF_TRUE
                            //        then
                            //            SCM_CURRENT_OFFSET = SCM_COND_START_OFFSET
                            //        end
                            //    end
                            //end
                        end

                        call @clear_buffer 3 SCM_BUFFER_BLIPS MAX_CONDITIONS BUFFER_BLIPS
                        call @clear_buffer 3 SCM_BUFFER_SPHERES MAX_CONDITIONS BUFFER_SPHERES

                        call @clear_buffer 3 SCM_BUFFER_ACTORS SCM_NUM_ACTORS BUFFER_ACTORS

                        Display.SetRadar(false)
                        if not Actor.IsDriving(hPlayer)
                        then Actor.SetCollisionDetection(hPlayer) = false
                        end
                        Player.SetCanMove(hChar) = false
                        Player_RemindPosition()
                    end
                    printf "finish, closed file" WAIT_INFO
                    call @waitPlis 2 WAIT_INFO false
                    
                    Menu_Display_Show()
                    jump @Menu_Mission
                else
                    printf "file not exist" WAIT_ERROR
                    call @waitPlis 2 WAIT_ERROR false
                end

                Menu.SetActiveItem(hPanel, 2)
                jump @Menu_Mission

            case 3 // Reset

                Menu.SetColumn(hPanel, 0, 'M0000A1','M0000A0','M00009Z',none,none,none,none,none,none,none,none,none,none)
                Menu_Take_Return()
                Menu_Take_Selection()
                repeat
                    if Menu_Enter()
                    then
                        if _SELECTED == 0
                        then goto @Menu_Mission
                        end

                        if _SELECTED == 1
                        then
                            reset_file()
                            Menu.SetItemWithNumber(hPanel, 1, 1, 'M00000]', 4) // 4b
                            break
                        end
                    end
                until Menu_Return()

                Menu.SetActiveItem(hPanel, 4)
                jump @Menu_Mission
            default
                Text.PrintHelp('M0000WQ') // fuera de rango
                Menu.SetActiveItem(hPanel, _SELECTED)
                jump @Menu_Mission
        end//switch _SELECTED
    end
until Menu_Return()  
setMenuClear()
Menu.SetActiveItem(hPanel, MENU_MISSION)
jump @Menu_iMain


:File_Chech_Exist
    if CURRENT_PLATFORM == __PLATFORM_WINDOWS
    then DIR_DYOS = "CLEO/DYOS/#0"
    else DIR_DYOS = "/DYOS/#0"
    end
    if 0AAB:  does_file_exist DIR_DYOS
    then
        FILE_EXIST = true
        
        0A9A: FILE_HANDLE = DIR_DYOS "rb"
        0A9C: FILE_SIZE = file FILE_HANDLE size
        0A9B: file_close FILE_HANDLE
    else
        if 0A9A: FILE_HANDLE = DIR_DYOS "rb"
        then
            Fs.Close(FILE_HANDLE)
            FILE_EXIST = true
        else
            FILE_EXIST = false
            Text.PrintHelp('M00000+')
        end
    end
return

:read_buffer_Value
    2401: read_memory_with_offset SCM_BUFFER_MAIN offset SCM_CURRENT_OFFSET size 4 store_to 0@
    SCM_CURRENT_OFFSET += 4
return

:read_buffer_Vec3
    2401: read_memory_with_offset SCM_BUFFER_MAIN offset SCM_CURRENT_OFFSET size 4 store_to 0@
    SCM_CURRENT_OFFSET += 4
    2401: read_memory_with_offset SCM_BUFFER_MAIN offset SCM_CURRENT_OFFSET size 4 store_to 1@
    SCM_CURRENT_OFFSET += 4
    2401: read_memory_with_offset SCM_BUFFER_MAIN offset SCM_CURRENT_OFFSET size 4 store_to 2@
    SCM_CURRENT_OFFSET += 4
return

:read_found_error
    Display.SetRadar(false)
    if not Actor.IsDriving(hPlayer)
    then Actor.SetCollisionDetection(hPlayer) = false
    end
    Player.SetCanMove(hChar) = false
    Menu_Display_Show()
    Player_RemindPosition()
    Menu.SetActiveItem(hPanel, 2)
goto @Menu_Mission

:reset_file
    if 0A9A: FILE_HANDLE = DIR_DYOS "wb"
    then
        FILE_OFFSET = 0
        
        // FILE_VERSION [XXX][XX]
        //
        // [XXX] : INT version
        // [XX] : INT build
        0A9E: write_file FILE_HANDLE size 4 from 300010 // DYOS 3.0.0-10
        Fs.Close(FILE_HANDLE)
    end
return

:clear_buffer
    // 0@ buffer
    // 1@ size
    // 2@ type

    int 0@
    int 1@

    int 5@ = 0
    int 6@ = 0
    if 2@ == BUFFER_ACTORS
    then
        FixUpdate()
        while SCM_NUM_ACTORS > 0
            
            31@ = SCM_NUM_ACTORS * 19
            2401: read_memory_with_offset SCM_BUFFER_ACTORS offset 31@ size 4 store_to 10@
            Actor.Remove(10@)

            SCM_NUM_ACTORS -= 1
        end
    else
        while 5@ < 1@
            6@ = 5@ * 4

            2401: read_memory_with_offset 0@ offset 6@ size 4 store_to 10@
            
            //if 2@ == BUFFER_MARKERS
            //then Blip.Remove(10@)
            //end
            if 2@ == BUFFER_SPHERES
            then Sphere.Remove(10@)
            end
            if 2@ == BUFFER_BLIPS
            then Blip.Remove(10@)
            end
            if 2@ == BUFFER_VEHICLES
            then Car.Remove(10@)
            end
            if 2@ == BUFFER_OBJECTS
            then Object.Remove(10@)
            end
            if 2@ == BUFFER_PARTICLES
            then Particle.Remove(10@)
            end
            if 2@ == BUFFER_PICKUPS
            then Pickup.Remove(10@)
            end
            if 2@ == BUFFER_SEARCHLIGHT
            then Searchlight.Remove(10@)
            end


            2402: write_memory_with_offset 0@ offset 6@ size 4 value 0
            5@ += 1
        end
    end
ret 0

{$I ./scm_read_command.txt}
{$I ./scm_write_command.txt}